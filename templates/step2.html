{% extends "index.html" %}

{% block progress_width %}28%{% endblock %}
{% block progress_value %}28{% endblock %}
{% block progress_text %}Step 2: Name Rooms & Set Orientations{% endblock %}

{% block step1_active %}completed{% endblock %}
{% block step2_active %}active{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body p-4">
        <div class="row">
            <!-- Left column: Form for apartment naming and orientation -->
            <div class="col-md-5">
                <h5 class="mb-3">Apartment Names and Orientations</h5>
                <div class="alert alert-info">
                    <p class="mb-0">Edit apartment names, room names, and set tile orientations for each apartment.</p>
                </div>
                
                <!-- Mode Toggle Buttons -->
                <div class="text-center mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="viewModeBtn">View Mode</button>
                        <button type="button" class="btn btn-outline-primary" id="editModeBtn">Edit Mode</button>
                    </div>
                </div>
                
                <!-- Status Alert -->
                <div class="alert alert-info text-center" id="statusAlert">
                    View Mode: Click room names to see details
                </div>
                
                <div class="naming-container" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                    <form id="namingForm">
                        {% for apartment in apartments %}
                        <div class="card mb-4 apartment-card">
                            <div class="card-header bg-light">
                                <div class="row">
                                    <div class="col-4">
                                        <h6 class="mt-1 mb-0">Apartment</h6>
                                    </div>
                                    <div class="col-8">
                                        <input type="text" class="form-control form-control-sm apartment-name" 
                                            data-original-name="{{ apartment.apartment_name }}"
                                            value="{{ apartment.apartment_name }}" 
                                            placeholder="Apartment Name">
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label class="form-label">Orientation</label>
                                        <select class="form-select form-select-sm apartment-orientation">
                                            <option value="0">0째 (Horizontal)</option>
                                            <option value="90">90째 (Vertical)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Current Name</th>
                                                <th>New Name</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for room in apartment.rooms %}
                                            <tr>
                                                <td>{{ room.room_id }}</td>
                                                <td>{{ room.room_name }}</td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm room-name" 
                                                        data-room-id="{{ room.room_id }}"
                                                        value="{{ room.room_name }}" 
                                                        placeholder="Room Name">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </form>
                </div>
                
                <!-- Save button outside the scrollable area -->
                <div class="mt-3 mb-3">
                    <button type="button" class="btn btn-primary w-100" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2" id="saveSpinner" role="status" aria-hidden="true"></span>
                        Save Names & Orientations
                    </button>
                </div>
                
                <div class="alert alert-success mt-3 d-none" id="successAlert">
                    <strong>Success!</strong> Names and orientations have been updated.
                </div>

                <div class="alert alert-danger mt-3 d-none" id="errorAlert"></div>
            </div>
            
            <!-- Right column: Layout visualizations -->
            <div class="col-md-7">
                <div class="row">
                    <!-- Interactive Layout -->
                    <div class="col-md-12">
                        <h5 class="mb-3">Interactive Layout</h5>
                        <div class="border rounded mb-4">
                            <div id="layoutPlot" class="text-center p-3">
                                {% if cluster_plot %}
                                
                                <!-- Plot Container with Overlay -->
                                <div id="plotContainer" style="position: relative; display: inline-block;">
                                    <img src="data:image/png;base64,{{ cluster_plot }}" alt="Apartment Clusters" class="img-fluid" id="plotImage">
                                    
                                    <!-- Room Labels Overlay - populated by JavaScript -->
                                    <div id="roomOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                        <!-- Room labels will be added here by JavaScript -->
                                    </div>
                                </div>
                                
                                {% else %}
                                <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
                                    <div class="text-center text-muted">
                                        <i class="bi bi-houses" style="font-size: 2rem;"></i>
                                        <p class="mt-2">No layout available. Please complete Step 1 first.</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="text-center">
                            <button class="btn btn-success btn-sm me-2" id="saveAllBtn">Save All Changes</button>
                            <button class="btn btn-secondary btn-sm" id="resetAllBtn">Reset Names</button>
                        </div>
                    </div>
                </div>
                
                <!-- Guidelines -->
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h5 class="card-title m-0"><i class="bi bi-info-circle me-2"></i>Guidelines</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Interactive Editing:</h6>
                                <ul class="small">
                                    <li>Switch to Edit Mode to click room names directly</li>
                                    <li>View Mode shows room details when clicked</li>
                                    <li>Changes sync between plot and form</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Orientation:</h6>
                                <ul class="small">
                                    <li>0째 - Standard horizontal tile layout</li>
                                    <li>90째 - Rotated vertical tile layout</li>
                                    <li>Affects tile placement direction</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden room positions data for JavaScript -->
<script id="roomPositionsData" type="application/json">
{{ room_positions | tojson | safe }}
</script>

{% endblock %}

{% block prev_step %}
<a href="{{ url_for('step1') }}" class="btn btn-secondary">Previous: Load DXF</a>
{% endblock %}

{% block next_step %}
<a id="nextStep" href="{{ url_for('step3') }}" class="btn btn-primary disabled">Next: Tile Coverage</a>
{% endblock %}

{% block head_extra %}
<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let currentMode = 'view';
    let roomPositions = [];
    
    // Load room positions from hidden script tag
    try {
        const roomPositionsScript = document.getElementById('roomPositionsData');
        if (roomPositionsScript) {
            roomPositions = JSON.parse(roomPositionsScript.textContent);
        }
    } catch (e) {
        console.error('Error loading room positions:', e);
        roomPositions = [];
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeInterface();
        createRoomOverlays();
        setupEventHandlers();
    });
    
    function initializeInterface() {
        // Mode toggle buttons
        document.getElementById('viewModeBtn').addEventListener('click', function() {
            setMode('view');
        });
        
        document.getElementById('editModeBtn').addEventListener('click', function() {
            setMode('edit');
        });
        
        // Action buttons
        document.getElementById('saveAllBtn').addEventListener('click', function() {
            showStatus('All changes saved automatically!', 'success');
        });
        
        document.getElementById('resetAllBtn').addEventListener('click', function() {
            if (confirm('Reset all room names to original values?')) {
                location.reload();
            }
        });
        
        // Form inputs sync
        document.querySelectorAll('.room-name').forEach(function(input) {
            input.addEventListener('change', function() {
                syncFormToOverlay(this.dataset.roomId, this.value);
            });
        });
        
        // Original save functionality
        setupOriginalSaveHandler();
    }
    
    function createRoomOverlays() {
        const overlay = document.getElementById('roomOverlay');
        if (!overlay || !roomPositions || roomPositions.length === 0) {
            return;
        }
        
        overlay.innerHTML = ''; // Clear existing
        
        roomPositions.forEach(function(room) {
            const label = document.createElement('div');
            label.className = 'room-overlay-label';
            label.textContent = room.room_name;
            label.dataset.roomId = room.room_id;
            label.dataset.roomName = room.room_name;
            label.dataset.apartment = room.apartment_name;
            
            // Position the label
            label.style.position = 'absolute';
            label.style.left = room.x_percent + '%';
            label.style.top = room.y_percent + '%';
            label.style.transform = 'translate(-50%, -50%)';
            label.style.background = 'rgba(255, 255, 255, 0.9)';
            label.style.border = '1px solid #ccc';
            label.style.borderRadius = '4px';
            label.style.padding = '2px 6px';
            label.style.fontSize = '11px';
            label.style.fontWeight = '600';
            label.style.cursor = 'pointer';
            label.style.pointerEvents = 'auto';
            label.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
            label.style.minWidth = '50px';
            label.style.textAlign = 'center';
            label.style.zIndex = '10';
            label.style.transition = 'all 0.2s ease';
            
            // Add click handler
            label.addEventListener('click', function() {
                if (currentMode === 'view') {
                    showRoomDetails(this);
                } else {
                    editRoomName(this);
                }
            });
            
            // Add hover effects
            label.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(102, 126, 234, 0.1)';
                this.style.borderColor = '#667eea';
                this.style.transform = 'translate(-50%, -50%) scale(1.05)';
            });
            
            label.addEventListener('mouseleave', function() {
                if (!this.classList.contains('editing')) {
                    this.style.background = 'rgba(255, 255, 255, 0.9)';
                    this.style.borderColor = '#ccc';
                    this.style.transform = 'translate(-50%, -50%)';
                }
            });
            
            overlay.appendChild(label);
        });
    }
    
    function setMode(mode) {
        currentMode = mode;
        
        // Update button states
        document.getElementById('viewModeBtn').classList.toggle('active', mode === 'view');
        document.getElementById('editModeBtn').classList.toggle('active', mode === 'edit');
        
        // Update status
        const status = document.getElementById('statusAlert');
        if (mode === 'view') {
            status.textContent = 'View Mode: Click room names to see details';
            status.className = 'alert alert-info text-center';
        } else {
            status.textContent = 'Edit Mode: Click room names to edit directly';
            status.className = 'alert alert-warning text-center';
        }
    }
    
    function showRoomDetails(label) {
        const roomName = label.dataset.roomName;
        const apartment = label.dataset.apartment;
        const roomId = label.dataset.roomId;
        
        showStatus('Room: ' + roomName + ' | Apartment: ' + apartment + ' | ID: ' + roomId, 'info');
    }
    
    function editRoomName(label) {
        if (label.querySelector('input')) return; // Already editing
        
        const currentName = label.textContent;
        const roomId = label.dataset.roomId;
        
        // Create input
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentName;
        input.style.border = 'none';
        input.style.background = 'transparent';
        input.style.outline = 'none';
        input.style.fontSize = '11px';
        input.style.fontWeight = '600';
        input.style.width = '100%';
        input.style.textAlign = 'center';
        input.style.minWidth = '50px';
        
        // Replace content
        label.innerHTML = '';
        label.appendChild(input);
        label.style.background = 'white';
        label.style.borderColor = '#667eea';
        label.style.borderWidth = '2px';
        
        input.focus();
        input.select();
        
        // Save handlers
        const saveEdit = function() {
            const newName = input.value.trim();
            if (newName && newName !== currentName) {
                saveRoomName(label, roomId, newName);
            } else {
                cancelEdit(label, currentName);
            }
        };
        
        const cancelEdit = function(labelEl, originalName) {
            labelEl.textContent = originalName;
            labelEl.style.background = 'rgba(255, 255, 255, 0.9)';
            labelEl.style.borderColor = '#ccc';
            labelEl.style.borderWidth = '1px';
        };
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEdit();
            } else if (e.key === 'Escape') {
                cancelEdit(label, currentName);
            }
        });
    }
    
    function saveRoomName(label, roomId, newName) {
        fetch('/update_room_name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                room_id: parseInt(roomId),
                new_name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update overlay label
                label.textContent = newName;
                label.dataset.roomName = newName;
                label.style.background = 'rgba(255, 255, 255, 0.9)';
                label.style.borderColor = '#ccc';
                label.style.borderWidth = '1px';
                
                // Update form input
                syncOverlayToForm(roomId, newName);
                
                showStatus('Updated "' + newName + '" successfully', 'success');
            } else {
                showStatus('Error: ' + data.error, 'danger');
                label.textContent = label.dataset.roomName;
                label.style.background = 'rgba(255, 255, 255, 0.9)';
                label.style.borderColor = '#ccc';
                label.style.borderWidth = '1px';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus('Network error occurred', 'danger');
            label.textContent = label.dataset.roomName;
            label.style.background = 'rgba(255, 255, 255, 0.9)';
            label.style.borderColor = '#ccc';
            label.style.borderWidth = '1px';
        });
    }
    
    function syncFormToOverlay(roomId, newName) {
        const overlayLabel = document.querySelector('.room-overlay-label[data-room-id="' + roomId + '"]');
        if (overlayLabel) {
            overlayLabel.textContent = newName;
            overlayLabel.dataset.roomName = newName;
        }
    }
    
    function syncOverlayToForm(roomId, newName) {
        const formInput = document.querySelector('.room-name[data-room-id="' + roomId + '"]');
        if (formInput) {
            formInput.value = newName;
        }
    }
    
    function showStatus(message, type) {
        const status = document.getElementById('statusAlert');
        status.textContent = message;
        status.className = 'alert alert-' + type + ' text-center';
        
        if (type === 'success') {
            setTimeout(function() {
                setMode(currentMode); // Reset to mode message
            }, 3000);
        }
    }
    
    function setupEventHandlers() {
        // Add any additional event handlers here
    }
    
    // Original save button functionality
    function setupOriginalSaveHandler() {
        const saveButton = document.getElementById('saveButton');
        const saveSpinner = document.getElementById('saveSpinner');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const nextStep = document.getElementById('nextStep');
        
        saveButton.addEventListener('click', function() {
            // Show processing indicators
            saveButton.disabled = true;
            saveSpinner.classList.remove('d-none');
            errorAlert.classList.add('d-none');
            successAlert.classList.add('d-none');
            
            // Gather data from form
            const apartments = [];
            const orientations = [];
            const apartmentCards = document.querySelectorAll('.apartment-card');
            
            apartmentCards.forEach(card => {
                const originalName = card.querySelector('.apartment-name').getAttribute('data-original-name');
                const newName = card.querySelector('.apartment-name').value.trim();
                const orientation = parseInt(card.querySelector('.apartment-orientation').value);
                
                const rooms = [];
                card.querySelectorAll('.room-name').forEach(roomInput => {
                    const roomId = parseInt(roomInput.getAttribute('data-room-id'));
                    const newRoomName = roomInput.value.trim();
                    
                    rooms.push({
                        room_id: roomId,
                        new_name: newRoomName
                    });
                });
                
                apartments.push({
                    original_name: originalName,
                    new_name: newName,
                    orientation: orientation,
                    rooms: rooms
                });
                
                orientations.push({
                    apartment_name: newName,
                    orientation: orientation
                });
            });
            
            // Send data to server
            fetch('/step2', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ apartments, orientations })
            })
            .then(response => response.json())
            .then(data => {
                // Hide processing indicators
                saveButton.disabled = false;
                saveSpinner.classList.add('d-none');
                
                if (data.error) {
                    // Show error
                    errorAlert.textContent = data.error;
                    errorAlert.classList.remove('d-none');
                } else {
                    // Show success
                    successAlert.classList.remove('d-none');
                    nextStep.classList.remove('disabled');
                    
                    showStatus('All changes saved successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                saveButton.disabled = false;
                saveSpinner.classList.add('d-none');
                errorAlert.textContent = 'Network error occurred';
                errorAlert.classList.remove('d-none');
            });
        });
    }
</script>
{% endblock %}